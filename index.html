<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Quest - R√©√©ducation Vocale</title>
    <style>
        :root {
            --primary: #4a7b9d;
            --primary-dark: #2c3e50;
            --secondary: #87b5b5;
            --accent: #f39c12;
            --success: #27ae60;
            --warning: #e74c3c;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #87b5b5 0%, #4a7b9d 100%);
            min-height: 100vh;
            color: var(--dark);
            padding-bottom: 50px;
        }

        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        header {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo h1 {
            color: var(--primary-dark);
            font-size: 1.5rem;
        }

        nav ul {
            display: flex;
            list-style: none;
            gap: 10px;
            flex-wrap: wrap;
        }

        nav a {
            text-decoration: none;
            color: var(--dark);
            padding: 8px 16px;
            border-radius: 20px;
            transition: all 0.3s ease;
            white-space: nowrap;
            display: inline-block;
        }

        nav a:hover {
            background-color: var(--light);
        }

        nav a.active {
            background: var(--primary);
            color: white;
        }

        /* Main Content */
        .page {
            display: none;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: var(--shadow);
            min-height: 60vh;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .page.active {
            display: block;
        }

        /* Dashboard */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .dashboard-card {
            background: var(--light);
            border-radius: 10px;
            padding: 20px;
            border-left: 4px solid var(--primary);
        }

        .energy-bar {
            width: 100%;
            height: 20px;
            background: #ddd;
            border-radius: 10px;
            margin: 10px 0;
            overflow: hidden;
        }

        .energy-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success), var(--accent));
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .action-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.2s ease;
            font-weight: 600;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            background: var(--primary-dark);
        }

        /* Modules */
        .modules-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .module-card {
            background: var(--light);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid transparent;
        }

        .module-card:hover {
            transform: translateY(-5px);
            border-color: var(--accent);
            box-shadow: var(--shadow);
        }

        .module-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #ddd;
            border-radius: 4px;
            margin: 10px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--success);
            border-radius: 4px;
        }

        /* Exercices */
        .exercise-container {
            max-width: 600px;
            margin: 0 auto;
        }

        .exercise-card {
            background: var(--light);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
        }

        .timer {
            font-size: 3rem;
            text-align: center;
            margin: 20px 0;
            color: var(--primary);
        }

        .timer-circle {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            border: 8px solid var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            font-size: 2.5rem;
            font-weight: bold;
            background: white;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        
        .btn-secondary { background: var(--secondary); color: white; }
        .btn-secondary:hover { opacity: 0.9; }
        
        .btn-success { background: var(--success); color: white; }
        .btn-warning { background: var(--warning); color: white; }

        /* Profil */
        .profile-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2rem;
            border: 4px solid white;
            box-shadow: var(--shadow);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .stat-card {
            background: var(--light);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .badges-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin: 20px 0;
        }

        .badge {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            position: relative;
            cursor: help;
        }

        .badge.locked {
            background: #ddd;
            color: #999;
        }

        .badge-tooltip {
            position: absolute;
            bottom: -40px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--dark);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.8rem;
            white-space: nowrap;
            display: none;
            z-index: 100;
        }

        .badge:hover .badge-tooltip {
            display: block;
        }

        /* Parcours */
        .parcours-steps {
            max-width: 800px;
            margin: 0 auto;
        }

        .step {
            background: var(--light);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .step-number {
            background: var(--primary);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        /* Responsive */
        @media (max-width: 768px) {
            header { flex-direction: column; }
            nav ul { justify-content: center; }
            
            .dashboard-grid { grid-template-columns: 1fr; }
            .quick-actions { grid-template-columns: 1fr 1fr; }

            .controls { flex-direction: column; align-items: center; }
            .btn { width: 100%; max-width: 200px; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header>
            <div class="logo">
                <h1>üéµ Voice Quest</h1>
            </div>
            <nav>
                <ul>
                    <li><a href="#" class="nav-link active" data-page="dashboard">Tableau de Bord</a></li>
                    <li><a href="#" class="nav-link" data-page="modules">Modules</a></li>
                    <li><a href="#" class="nav-link" data-page="parcours">Parcours</a></li>
                    <li><a href="#" class="nav-link" data-page="profil">Profil</a></li>
                </ul>
            </nav>
        </header>

        <section id="dashboard" class="page active">
            <h2>Bon retour, <span id="user-name">Joueur</span> !</h2>
            
            <div class="dashboard-grid">
                <div class="dashboard-card">
                    <h3>üìä √âtat du Jour</h3>
                    <p>√ânergie vocale:</p>
                    <div class="energy-bar">
                        <div class="energy-fill" id="energy-fill" style="width: 80%;"></div>
                    </div>
                    <p>S√©rie actuelle: <span id="current-streak">0</span> jours</p>
                    <p>Prochain niveau: <span id="next-level-xp">100</span> XP</p>
                </div>
                
                <div class="dashboard-card">
                    <h3>üèÜ Badges R√©cents</h3>
                    <div id="recent-badges" class="badges-container">
                        </div>
                </div>

                <div class="dashboard-card">
                    <h3>üéØ Objectifs du Jour</h3>
                    <div id="daily-objectives">
                        </div>
                    <button class="btn btn-primary" id="generate-quest" style="margin-top: 15px; width: 100%;">
                        G√©n√©rer une nouvelle qu√™te
                    </button>
                </div>
            </div>

            <h3 style="margin: 30px 0 15px 0;">üéØ Acc√®s Rapide (Modules)</h3>
            <div class="quick-actions">
                <button class="action-btn" data-module="souffle">üí® Souffle</button>
                <button class="action-btn" data-module="voix">üéµ Voix</button>
                <button class="action-btn" data-module="articulation">üó£Ô∏è Articulation</button>
                <button class="action-btn" data-module="renforcement">üëÑ Renforcement</button>
                <button class="action-btn" data-module="deglutition">üßè D√©glutition</button>
            </div>

            <h3 style="margin: 30px 0 15px 0;">üó∫Ô∏è Acc√®s Rapide (Parcours)</h3>
            <div class="quick-actions">
                <button class="action-btn" data-parcours="decouverte">üîµ D√©couverte</button>
                <button class="action-btn" data-parcours="complet">üü° Complet</button>
                <button class="action-btn" data-parcours="apaisant">üü¢ Apaisant</button>
                <button class="action-btn" data-parcours="detente">üü¢ D√©tente</button>
                <button class="action-btn" data-parcours="maintenance">üü° Maintenance</button>
            </div>
        </section>

        <section id="modules" class="page">
            <h2>üåç Modules Th√©matiques</h2>
            <p>Choisissez un module pour explorer ses exercices</p>
            <div class="modules-grid" id="modules-grid"></div>
        </section>

        <section id="exercices" class="page">
            <div style="margin-bottom: 20px;">
                <button class="btn btn-secondary" onclick="showPage('modules')">‚Üê Retour aux modules</button>
            </div>
            <div id="exercise-content"></div>
        </section>

        <section id="parcours" class="page">
            <h2>üó∫Ô∏è Parcours Guid√©s</h2>
            <p>Des sessions structur√©es pour diff√©rents besoins</p>
            <div class="modules-grid" id="parcours-grid"></div>
        </section>

        <section id="parcours-detail" class="page">
            <div id="parcours-content"></div>
        </section>

        <section id="profil" class="page">
            <div class="profile-header">
                <div class="avatar" id="user-avatar">J</div>
                <div>
                    <h2 id="profile-name">Joueur</h2>
                    <p>Niveau <span id="user-level">1</span> ‚Ä¢ <span id="user-xp">0</span> XP</p>
                    <p><span id="user-coins">0</span> pi√®ces</p>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <h3>üìÖ S√©rie</h3>
                    <p style="font-size: 2rem;" id="profile-streak">0 jours</p>
                </div>
                <div class="stat-card">
                    <h3>‚è±Ô∏è Temps Total</h3>
                    <p style="font-size: 2rem;" id="profile-time">0 min</p>
                </div>
                <div class="stat-card">
                    <h3>üí∞ Pi√®ces</h3>
                    <p style="font-size: 2rem;" id="profile-coins">0</p>
                </div>
                <div class="stat-card">
                    <h3>‚úÖ Sessions</h3>
                    <p style="font-size: 2rem;" id="profile-sessions">0</p>
                </div>
            </div>

            <h3>üèÜ Badges D√©bloqu√©s</h3>
            <div class="badges-container" id="profile-badges"></div>

            <div style="margin-top: 30px;">
                <button class="btn btn-primary" id="export-btn">üìä Exporter mes donn√©es (CSV)</button>
                <button class="btn btn-warning" id="reset-btn" style="margin-left: 10px;">üîÑ R√©initialiser tout</button>
            </div>

            <div style="margin-top: 30px;">
                <h3>üìà Historique (7 derniers jours)</h3>
                <div id="history-chart"></div>
            </div>
        </section>
    </div>

    <div class="modal" id="result-modal">
        <div class="modal-content">
            <h2 id="modal-title">Exercice Termin√© !</h2>
            <div id="modal-content"></div>
            <div class="controls" style="margin-top: 20px;">
                <button class="btn btn-primary" id="modal-close">Fermer</button>
            </div>
        </div>
    </div>

    <script>
        const DATA_VERSION = "1.0"; // Utilis√© pour r√©initialiser si la structure change

        // Donn√©es par d√©faut
        const defaultData = {
            version: DATA_VERSION,
            user: {
                name: "Joueur",
                level: 1,
                xp: 0,
                coins: 0,
                energy: 100,
                streak: 0,
                totalTime: 0,
                sessionCount: 0,
                lastLogin: null,
                objectives: [] // Important
            },
            modules: {
                souffle: { name: "For√™t des Souffles", completed: false, progress: 0, exercisesCompleted: 0, totalExercises: 5 },
                voix: { name: "Vall√©e des R√©sonances", completed: false, progress: 0, exercisesCompleted: 0, totalExercises: 5 },
                articulation: { name: "Temple de l'Articulation", completed: false, progress: 0, exercisesCompleted: 0, totalExercises: 5 },
                renforcement: { name: "Montagne Oro-Faciale", completed: false, progress: 0, exercisesCompleted: 0, totalExercises: 8 },
                deglutition: { name: "Source de la D√©glutition", completed: false, progress: 0, exercisesCompleted: 0, totalExercises: 3 }
            },
            badges: {
                novice: { name: "Novice", earned: true, description: "Compl√©ter votre premier exercice", icon: "üéØ" },
                explorateur: { name: "Explorateur", earned: false, description: "Essayer tous les modules", icon: "üß≠" },
                souffle_maitre: { name: "Ma√Ætre du Souffle", earned: false, description: "Compl√©ter le module Souffle", icon: "üí®" },
                voix_cristalline: { name: "Voix Cristalline", earned: false, description: "Compl√©ter le module Voix", icon: "üéµ" },
                articulation_parfaite: { name: "Articulation Parfaite", earned: false, description: "Compl√©ter le module Articulation", icon: "üó£Ô∏è" },
                perseverance: { name: "Pers√©v√©rance", earned: false, description: "7 jours d'activit√© cons√©cutifs", icon: "üî•" },
                marathonien: { name: "Marathonien", earned: false, description: "Compl√©ter un parcours de 45min", icon: "üèÉ" }
            },
            history: [],
            dailyQuest: null
        };

        // Variable globale de l'application
        let appData = JSON.parse(JSON.stringify(defaultData));

        // Exercices complets
        const exercises = {
            souffle: [
                { id: 1, name: "Bougie douce", instructions: "Soufflez doucement pour faire vaciller une flamme imaginaire sans l'√©teindre.", duration: 30, xp: 50, type: "timer" },
                { id: 2, name: "Bulles de savon", instructions: "Soufflez doucement pour cr√©er des bulles r√©guli√®res et stables.", duration: 45, xp: 60, type: "timer" },
                { id: 3, name: "Bougie √©loign√©e", instructions: "√âteignez une bougie que vous √©loignez progressivement.", duration: 40, xp: 70, type: "timer" },
                { id: 4, name: "Moulin √† vent", instructions: "Soufflez de mani√®re r√©guli√®re pour faire tourner un moulinet.", duration: 60, xp: 80, type: "timer" },
                { id: 5, name: "Ballons", instructions: "Gonflez un ballon en plusieurs expirations contr√¥l√©es.", duration: 90, xp: 100, type: "timer" }
            ],
            voix: [
                { id: 1, name: "Posture", instructions: "Tenez-vous droit, sternum ouvert, respiration abdominale.", duration: 60, xp: 40, type: "timer" },
                { id: 2, name: "B√¢illement vois√©", instructions: "Inspirez bouche grande ouverte, expirez sur un 'A' doux.", duration: 45, xp: 60, type: "repetition", reps: 5 },
                { id: 3, name: "Ronronnement (Fry)", instructions: "Produisez un son grave et cr√©pitant, comme un ronron.", duration: 30, xp: 50, type: "timer" },
                { id: 4, name: "Le Cheval", instructions: "Faites vibrer vos l√®vres en produisant un 'Brrrr'.", duration: 40, xp: 55, type: "timer" },
                { id: 5, name: "Sons graves", instructions: "Tenez un 'hoooo' tr√®s grave et d√©tendu.", duration: 60, xp: 65, type: "timer" }
            ],
            articulation: [
                { id: 1, name: "R√©p√©titions", instructions: "Prononcez clairement : 'pa-ta-ka', 'ma-na-la'.", duration: 60, xp: 50, type: "repetition", reps: 10 },
                { id: 2, name: "Grrrr et Crrrr", instructions: "Insistez sur les consonnes : 'Grrrr', 'Crrrr'.", duration: 45, xp: 55, type: "repetition", reps: 8 },
                { id: 3, name: "Le Ch√™ne et le Roseau", instructions: "Lisez en alternant une ligne forte et une ligne douce.", duration: 120, xp: 80, type: "timer" },
                { id: 4, name: "La Cigale et la Fourmi", instructions: "R√©citez en articulant chaque syllabe clairement.", duration: 120, xp: 80, type: "timer" },
                { id: 5, name: "Virelangues", instructions: "Les chaussettes de l'archiduchesse sont-elles s√®ches ?", duration: 90, xp: 70, type: "repetition", reps: 5 }
            ],
            renforcement: [
                { id: 1, name: "Bisous sonores", instructions: "Envoyez des bisous bien claquants.", duration: 45, xp: 40, type: "repetition", reps: 15 },
                { id: 2, name: "Sourires altern√©s", instructions: "Souriez largement √† gauche, puis √† droite.", duration: 60, xp: 45, type: "repetition", reps: 10 },
                { id: 3, name: "OU-I exag√©r√©", instructions: "Alternez 'OU' et 'I' de fa√ßon exag√©r√©e.", duration: 90, xp: 60, type: "repetition", reps: 20 },
                { id: 4, name: "Claquements de langue", instructions: "Claquez la langue ('clac clac clac').", duration: 45, xp: 40, type: "repetition", reps: 15 },
                { id: 5, name: "Balayage du palais", instructions: "Passez le bout de la langue du palais dur au voile.", duration: 60, xp: 45, type: "repetition", reps: 10 },
                { id: 6, name: "√âlastique en √©quilibre", instructions: "Tenez un √©lastique sur le bout de votre langue.", duration: 30, xp: 50, type: "timer" },
                { id: 7, name: "Ouverture/Fermeture", instructions: "Ouvrez et fermez la bouche lentement.", duration: 90, xp: 45, type: "repetition", reps: 10 },
                { id: 8, name: "Gonflement r√©sist√©", instructions: "Gonflez les joues et r√©sistez √† la pression.", duration: 30, xp: 50, type: "timer" }
            ],
            deglutition: [
                { id: 1, name: "D√©glutition volontaire", instructions: "Avalez votre salive en sentant le larynx.", duration: 90, xp: 50, type: "repetition", reps: 10 },
                { id: 2, name: "Man≈ìuvre de Masako", instructions: "Langue entre les dents, avalez.", duration: 120, xp: 70, type: "repetition", reps: 10 },
                { id: 3, name: "Man≈ìuvre de Mendelson", instructions: "Avalez et maintenez le larynx en haut.", duration: 120, xp: 80, type: "repetition", reps: 8 }
            ]
        };

        // Parcours
        const parcours = {
            decouverte: { name: "Parcours D√©couverte", duration: 15, difficulty: "d√©butant", description: "Id√©al pour d√©buter", steps: [{exercise: "Posture", module: "voix", duration: 60}, {exercise: "Bougie douce", module: "souffle", duration: 45}, {exercise: "Bisous sonores", module: "renforcement", duration: 30}], xp: 200, validation: "Je prends soin de ma voix." },
            complet: { name: "Parcours Complet", duration: 45, difficulty: "interm√©diaire", description: "Session int√©grative", steps: [{exercise: "Posture", module: "voix", duration: 60}, {exercise: "Moulin √† vent", module: "souffle", duration: 180}, {exercise: "Le Cheval", module: "voix", duration: 150}], xp: 500, validation: "Je retrouve ma voix." },
            apaisant: { name: "Parcours Apaisant", duration: 10, difficulty: "tous niveaux", description: "Pour la fatigue vocale", steps: [{exercise: "Ronronnement (Fry)", module: "voix", duration: 60}, {exercise: "Sons graves", module: "voix", duration: 60}], xp: 100, validation: "Repos vocal." },
            detente: { name: "Parcours D√©tente", duration: 15, difficulty: "tous niveaux", description: "Pour rel√¢cher les tensions", steps: [{exercise: "B√¢illement vois√©", module: "voix", duration: 120}, {exercise: "Sons graves", module: "voix", duration: 120}], xp: 150, validation: "D√©tente." },
            maintenance: { name: "Parcours Maintenance", duration: 20, difficulty: "interm√©diaire", description: "Session d'entretien", steps: [{exercise: "R√©p√©titions", module: "articulation", duration: 120}, {exercise: "OU-I exag√©r√©", module: "renforcement", duration: 90}], xp: 200, validation: "Maintenance." }
        };

        // --- Initialisation ---
        document.addEventListener('DOMContentLoaded', function() {
            try {
                setupEventListeners(); // Charger les √©couteurs D'ABORD
                initializeApp();
            } catch (e) {
                console.error("Erreur critique au d√©marrage:", e);
                alert("Une erreur est survenue lors du chargement. R√©initialisation des donn√©es...");
                resetData();
            }
        });

        function setupEventListeners() {
            // Navigation
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    // Utilisation de currentTarget pour √™tre s√ªr d'avoir le lien
                    const targetPage = e.currentTarget.getAttribute('data-page');
                    if(targetPage) showPage(targetPage);
                });
            });

            // Actions rapides - Modules
            document.querySelectorAll('.action-btn[data-module]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const module = e.currentTarget.getAttribute('data-module');
                    showModuleExercises(module);
                });
            });

            // Actions rapides - Parcours
            document.querySelectorAll('.action-btn[data-parcours]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const parcoursName = e.currentTarget.getAttribute('data-parcours');
                    showParcoursDetail(parcoursName);
                });
            });

            // Boutons globaux
            const btnQuest = document.getElementById('generate-quest');
            if(btnQuest) btnQuest.addEventListener('click', generateDailyQuest);

            const btnExport = document.getElementById('export-btn');
            if(btnExport) btnExport.addEventListener('click', exportData);

            const btnReset = document.getElementById('reset-btn');
            if(btnReset) btnReset.addEventListener('click', resetData);

            const btnClose = document.getElementById('modal-close');
            if(btnClose) btnClose.addEventListener('click', () => {
                document.getElementById('result-modal').classList.remove('active');
            });
        }

        function initializeApp() {
            loadSavedData();
            checkDailyLogin();
            updateDashboard();
            renderModules();
            renderParcours();
            updateProfile();
            generateDailyObjectives();
        }

        // --- Navigation et Rendu ---
        function showPage(pageId) {
            document.querySelectorAll('.nav-link').forEach(nav => nav.classList.remove('active'));
            const activeLink = document.querySelector(`[data-page="${pageId}"]`);
            if(activeLink) activeLink.classList.add('active');
            
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            const activePage = document.getElementById(pageId);
            if(activePage) activePage.classList.add('active');
        }

        // Exportation des fonctions au scope global pour les onclick="..."
        window.showPage = showPage;
        window.showModuleExercises = showModuleExercises;
        window.startExercise = startExercise;
        window.showParcoursDetail = showParcoursDetail;
        window.startParcours = startParcours;

        function showModuleExercises(moduleName) {
            const module = appData.modules[moduleName];
            const moduleExercises = exercises[moduleName];
            
            if(!module || !moduleExercises) return;

            let html = `
                <h2>${module.name}</h2>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${module.progress}%"></div>
                </div>
                <p style="margin-bottom:20px;">${module.progress}% compl√©t√©</p>
                <div class="exercise-container">
            `;
            
            moduleExercises.forEach(exercise => {
                const isCompleted = appData.history.some(h => h.module === moduleName && h.exerciseId === exercise.id);
                html += `
                    <div class="exercise-card">
                        <h3>${exercise.name} ${isCompleted ? '‚úÖ' : ''}</h3>
                        <p>${exercise.instructions}</p>
                        <p><small>‚è±Ô∏è ${exercise.duration}s | ‚≠ê ${exercise.xp} XP</small></p>
                        <div class="controls">
                            <button class="btn btn-primary" onclick="window.startExercise('${moduleName}', ${exercise.id})">
                                ${isCompleted ? 'Refaire' : 'Commencer'}
                            </button>
                        </div>
                    </div>
                `;
            });
            
            html += `</div>`;
            document.getElementById('exercise-content').innerHTML = html;
            showPage('exercices');
        }

        function startExercise(moduleName, exerciseId) {
            const exercise = exercises[moduleName].find(e => e.id === exerciseId);
            if (!exercise) return;
            
            let html = `
                <div class="exercise-card">
                    <h3>${exercise.name}</h3>
                    <p>${exercise.instructions}</p>
                    <div class="timer">
                        <div class="timer-circle" id="exercise-timer">${exercise.duration}</div>
                    </div>
                    <div class="controls">
                        <button class="btn btn-primary" id="start-btn">D√©marrer</button>
                        <button class="btn btn-secondary" id="pause-btn" disabled>Pause</button>
                        <button class="btn btn-warning" id="stop-btn" disabled>Arr√™ter</button>
                    </div>
                    <div id="repetition-counter" style="display: none; text-align: center; margin: 20px 0;">
                        <h3>R√©p√©titions: <span id="rep-count">0</span>/<span id="rep-total">${exercise.reps || 0}</span></h3>
                        <button class="btn btn-success" id="rep-btn">+1 R√©p√©tition</button>
                    </div>
                </div>
            `;
            
            document.getElementById('exercise-content').innerHTML = html;
            
            if (exercise.type === 'timer') {
                setupTimerExercise(exercise, moduleName);
            } else {
                setupRepetitionExercise(exercise, moduleName);
            }
        }

        function setupTimerExercise(exercise, moduleName) {
            let timeLeft = exercise.duration;
            let timerInterval;
            let isRunning = false;
            
            const btnStart = document.getElementById('start-btn');
            const btnPause = document.getElementById('pause-btn');
            const btnStop = document.getElementById('stop-btn');
            const timerDisplay = document.getElementById('exercise-timer');

            btnStart.addEventListener('click', () => {
                if (!isRunning) {
                    isRunning = true;
                    btnStart.disabled = true;
                    btnPause.disabled = false;
                    btnStop.disabled = false;
                    
                    timerInterval = setInterval(() => {
                        timeLeft--;
                        timerDisplay.textContent = timeLeft;
                        if (timeLeft <= 0) {
                            clearInterval(timerInterval);
                            completeExercise(exercise, moduleName, exercise.duration);
                        }
                    }, 1000);
                }
            });
            
            btnPause.addEventListener('click', () => {
                if (isRunning) {
                    clearInterval(timerInterval);
                    isRunning = false;
                    btnStart.disabled = false;
                    btnPause.disabled = true;
                    btnStart.textContent = 'Reprendre';
                }
            });
            
            btnStop.addEventListener('click', () => {
                clearInterval(timerInterval);
                const actualDuration = exercise.duration - timeLeft;
                completeExercise(exercise, moduleName, actualDuration);
            });
        }

        function setupRepetitionExercise(exercise, moduleName) {
            document.getElementById('repetition-counter').style.display = 'block';
            document.getElementById('start-btn').style.display = 'none'; // Cacher le bouton timer pour les r√©p√©titions
            document.getElementById('pause-btn').style.display = 'none';
            document.getElementById('stop-btn').disabled = false;
            document.getElementById('stop-btn').textContent = "Terminer";
            
            let repCount = 0;
            const totalReps = exercise.reps;
            
            document.getElementById('rep-btn').addEventListener('click', () => {
                repCount++;
                document.getElementById('rep-count').textContent = repCount;
                if (repCount >= totalReps) {
                    completeExercise(exercise, moduleName, exercise.duration);
                }
            });
            
            document.getElementById('stop-btn').addEventListener('click', () => {
                completeExercise(exercise, moduleName, exercise.duration, repCount);
            });
        }

        function completeExercise(exercise, moduleName, actualDuration, actualReps = null) {
            let completionRatio = 1;
            if (exercise.type === 'timer') completionRatio = Math.min(actualDuration / exercise.duration, 1);
            else completionRatio = Math.min((actualReps || 0) / exercise.reps, 1);
            
            const xpEarned = Math.round(exercise.xp * completionRatio);
            const coinsEarned = Math.round(xpEarned / 5);
            
            appData.user.xp += xpEarned;
            appData.user.coins += coinsEarned;
            appData.user.energy = Math.max(0, appData.user.energy - 5);
            appData.user.totalTime += Math.ceil(actualDuration / 60);
            appData.user.sessionCount++;
            
            const module = appData.modules[moduleName];
            const alreadyCompleted = appData.history.some(h => h.module === moduleName && h.exerciseId === exercise.id);
            
            if (!alreadyCompleted) {
                module.exercisesCompleted++;
                module.progress = Math.round((module.exercisesCompleted / module.totalExercises) * 100);
                if (module.exercisesCompleted === module.totalExercises) {
                    module.completed = true;
                    const badgeKey = `${moduleName}_maitre`;
                    if (appData.badges[badgeKey]) appData.badges[badgeKey].earned = true;
                }
            }
            
            appData.history.push({
                date: new Date().toISOString(),
                module: moduleName,
                exerciseId: exercise.id,
                xp: xpEarned
            });
            
            checkBadges();
            updateDashboard();
            updateProfile();
            saveData();
            showResultModal(exercise.name, xpEarned, coinsEarned);
        }

        function showResultModal(title, xp, coins) {
            const modal = document.getElementById('result-modal');
            const content = document.getElementById('modal-content');
            
            content.innerHTML = `
                <p style="font-size:1.2rem;">Bravo !</p>
                <p><strong>${title}</strong></p>
                <p>üéØ XP gagn√©: +${xp}</p>
                <p>üí∞ Pi√®ces: +${coins}</p>
            `;
            modal.classList.add('active');
        }

        // --- Logique Parcours ---
        function showParcoursDetail(parcoursName) {
            const pData = parcours[parcoursName];
            let html = `
                <h2>${pData.name}</h2>
                <p>${pData.duration} min ‚Ä¢ ${pData.difficulty}</p>
                <p>${pData.description}</p>
                <div class="parcours-steps"><h3 style="margin:20px 0;">√âtapes:</h3>
            `;
            
            pData.steps.forEach((step, index) => {
                html += `<div class="step"><div class="step-number">${index+1}</div><div><h4>${step.exercise}</h4></div></div>`;
            });
            
            html += `</div>
                <div class="controls" style="margin-top:30px;">
                    <button class="btn btn-primary" onclick="window.startParcours('${parcoursName}')">Commencer</button>
                </div>`;
            
            document.getElementById('parcours-content').innerHTML = html;
            showPage('parcours-detail');
        }

        function startParcours(parcoursName) {
            alert("Le mode parcours d√©marrera ici. (Simulation : +100 XP)");
            appData.user.xp += 100;
            updateDashboard();
            showPage('dashboard');
        }

        // --- G√©n√©ration Dynamique ---
        function renderModules() {
            const grid = document.getElementById('modules-grid');
            grid.innerHTML = '';
            const icons = { souffle: 'üí®', voix: 'üéµ', articulation: 'üó£Ô∏è', renforcement: 'üëÑ', deglutition: 'üßè' };
            
            Object.entries(appData.modules).forEach(([key, module]) => {
                const card = document.createElement('div');
                card.className = 'module-card';
                card.innerHTML = `
                    <div class="module-icon">${icons[key]}</div>
                    <h3>${module.name}</h3>
                    <div class="progress-bar"><div class="progress-fill" style="width: ${module.progress}%"></div></div>
                `;
                card.addEventListener('click', () => showModuleExercises(key));
                grid.appendChild(card);
            });
        }

        function renderParcours() {
            const grid = document.getElementById('parcours-grid');
            grid.innerHTML = '';
            Object.entries(parcours).forEach(([key, p]) => {
                const card = document.createElement('div');
                card.className = 'module-card';
                card.innerHTML = `<h3>${p.name}</h3><p>${p.duration} min</p>`;
                card.addEventListener('click', () => showParcoursDetail(key));
                grid.appendChild(card);
            });
        }

        // --- Gestion des Donn√©es ---
        function generateDailyQuest() {
            if (!appData.modules || Object.keys(appData.modules).length === 0) return;
            
            // Exemple d'objectifs simples
            appData.user.objectives = [
                { description: "Gagner 100 XP", required: 100, progress: 0, completed: false },
                { description: "Compl√©ter 1 exercice", required: 1, progress: 0, completed: false }
            ];
            updateDailyObjectives();
            saveData();
        }

        function updateDailyObjectives() {
            const container = document.getElementById('daily-objectives');
            container.innerHTML = '';
            if (!appData.user.objectives) return;
            
            appData.user.objectives.forEach(obj => {
                container.innerHTML += `<p>${obj.description} (${obj.progress}/${obj.required})</p>`;
            });
        }

        function updateDashboard() {
            document.getElementById('user-name').textContent = appData.user.name;
            document.getElementById('energy-fill').style.width = `${appData.user.energy}%`;
            document.getElementById('current-streak').textContent = appData.user.streak;
            
            const nextLevel = appData.user.level * 500;
            document.getElementById('next-level-xp').textContent = `${appData.user.xp}/${nextLevel}`;
        }

        function updateProfile() {
            document.getElementById('profile-name').textContent = appData.user.name;
            document.getElementById('user-level').textContent = appData.user.level;
            document.getElementById('user-xp').textContent = appData.user.xp;
            document.getElementById('user-coins').textContent = appData.user.coins;
            document.getElementById('profile-time').textContent = `${appData.user.totalTime} min`;
            
            // Badges
            const container = document.getElementById('profile-badges');
            container.innerHTML = '';
            Object.values(appData.badges).forEach(badge => {
                if(badge.earned) container.innerHTML += `<div class="badge">${badge.icon}</div>`;
            });
        }

        function checkBadges() {
            if(appData.user.streak >= 7) appData.badges.perseverance.earned = true;
        }

        function checkDailyLogin() {
            const today = new Date().toDateString();
            if (appData.user.lastLogin !== today) {
                appData.user.streak++;
                appData.user.lastLogin = today;
                appData.user.energy = 100;
                generateDailyQuest();
                saveData();
            }
        }

        function loadSavedData() {
            try {
                const saved = localStorage.getItem('voiceQuestData');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    // V√©rification de version pour √©viter les crashs
                    if(parsed.version === DATA_VERSION) {
                        appData = parsed;
                    } else {
                        console.warn("Version de donn√©es obsol√®te. R√©initialisation.");
                        // On pourrait essayer de migrer les donn√©es ici
                    }
                }
            } catch (e) {
                console.error("Erreur chargement donn√©es", e);
            }
        }

        function saveData() {
            try {
                localStorage.setItem('voiceQuestData', JSON.stringify(appData));
            } catch (e) {
                console.error("Sauvegarde impossible (quota ?)", e);
            }
        }

        function exportData() {
            alert("Export CSV simul√© (voir console)");
            console.log(appData.history);
        }

        function resetData() {
            if (confirm("R√©initialiser toute la progression ?")) {
                localStorage.removeItem('voiceQuestData');
                location.reload();
            }
        }
    </script>
</body>
</html>
